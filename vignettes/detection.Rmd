---
title: Detecting differentially abundant barcodes
author:
- name: Aaron Lun
  affiliation: Genentech gRED B&CB
  email: luna@gene.com
date: "Revised: December 2, 2019"  
output:
  BiocStyle::html_document
package: gp.sa.screen
vignette: >
  %\VignetteIndexEntry{2. Differential abundance}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE, results="hide"}
knitr::opts_chunk$set(error=FALSE, message=FALSE, warning=FALSE)
```

```{r, echo=FALSE, results="hide"}
library(BiocStyle)
library(gp.sa.core)
```

# Overview

The `r GRANpkg("gp.sa.screen")` package implements a pipeline function to detect differentially abundant barcodes in a (usually CRISPR) sequencing screen experiment.
This is based on the `voom()` method in the `r Biocpkg("limma")` package, operating on a matrix of barcode-by-sample counts.
The basic philosophy is the same as that described in the documentation for the `r GRANpkg("gp.sa.diff")` package - thus, we will mainly focus on the screen-specific parameters in this vignette.

# Setting up

## The project

First, we need to set up an analysis project directory using the `newProject()` function from the `r GRANpkg("gp.sa.core")` package.
This is simply a Git repository that will contain all the analysis scripts.

```{r}
library(gp.sa.core)

# Change the directory location as needed:
proj.dir <- file.path(tempdir(), "ScreenAnalysis")

newProject(proj.dir, title="Screening for barcodes",
    description="I'm testing for differences!")           
```

We change our working directory to this location.
Rstudio users may find it helpful to define a new project at the same path, which will automatically change the working directory.

```{r, eval=FALSE}
setwd(proj.dir)
```

```{r, echo=FALSE, results="hide"}
# Because knitr fights changes to the wd.
knitr::opts_knit$set(root.dir=proj.dir)
```

## The data

We will mock up an example sequencing screen dataset for demonstration purposes.
Our mock dataset will contain three replicate screens with three time points per sample, as represented in the experimental design below.

```{r}
run <- gl(3, 3)
time <- rep(0:2, 3)
data.frame(run, time)
```

We assume that we have 1000 barcodes, each of which targets one of 100 genes.
Of these, a small fraction are known control genes that should not exhibit any change over time.
The gene type is made available to us via the `gene.type` vector.

```{r}
Nbarcodes <- 1000

# Generating random assignments of barcodes to genes.
gene.id <- sample(paste0("GENE_", seq_len(100)), Nbarcodes, replace=TRUE)

# First 10 genes are non-essential controls.
gene.type <- ifelse(gene.id %in% paste0("GENE_", seq_len(10)), "NEG", ".")
```

Finally, we generate a random count matrix under the assumption that barcodes were added in equimolar quantities.

```{r}
y <- matrix(rnbinom(Nbarcodes * length(run), mu=100, size=10), ncol=length(run))
```

We use this information to construct a `SummarizedExperiment` object for input to our pipeline function.
Of course, in analyses of real data, we can just pull an object out of DataSetDB using `r GRANpkg("gdbR")`, 
or just pass a DataSetDB identifier as input into the pipeline.

```{r}
library(SummarizedExperiment)
se <- SummarizedExperiment(list(counts=y),
    rowData=DataFrame(ID=gene.id, Type=gene.type),
    colData=DataFrame(time=time, run=run))
se
```

# Running the pipeline

The `runVoomScreen()` function will, as its name suggests, run `voom()` on the sequencing screen count matrix to identify barcodes that change in abundance across a contrast of interest.
In our example, we want to identify barcodes that change in abundance over time.
Assuming a linear response in the log-abundance over time, we can do:

```{r, fig.show="hide"}
library(gp.sa.screen)
out <- runVoomScreen(se, 

    # Set up the experimental design and comparison of interest:
    covariates="time", comparisons="time", block="run", 
    
    # Screen-specific fields, see below:
    reference.field="time", reference.level=0,
    norm.type.field="Type", norm.type.level="NEG", gene.field="ID"
)
out
```

In addition to the standard differential analysis arguments passed to `runVoom()`, we require several screen-specific arguemnts:

- `reference.field` and `reference.level`, which specify the samples that belong to the reference group (i.e., prior to any selection process over time).
This information is used for filtering out low-abundance barcodes that were not generated in the same quantities as the other barcodes during library manufacture.
In this case, our reference samples are those that are at time zero.
- `norm.type.field` and `norm.type.level`, which specify the negative control barcodes.
These barcodes should not change during the course of an experiment and thus can be used for normalization.
In this case, our negative controls are specified as `"NEG"`s (i.e., non-essential genes) in the `Type` row metadata field.
One may alternatively see `"NTC"`s (i.e., non-targeting controls) in real experiments.
- `gene.field`, which specifies the barcode-to-gene mappings.
In this case, the relevant row metadata field is `ID`.

The `runVoomScreen()` function will produce two result tables per comparison.
The first table refers to the barcode-level results and contains the typical fields that one might expect from a `voom()` analysis
(see also `?runVoom` from the `r GRANpkg("gp.sa.diff")` package).

```{r}
out$barcode[[1]]
```

The other table contains gene-level results from consolidating the statistics across barcodes for each gene.
By default, we combine $p$-values across barcodes using Simes' method, which tests the null hypothesis that all barcodes for a given gene are not differentially abundant.
The number of barcodes changing in each direction and the net direction of the change for a gene is reported, though the latter may not be well-defined if multiple barcodes change strongly in different directions.
Log-fold changes and log-counts-per-million are also reported for the "best" barcode (i.e., with the lowest $p$-value) in each gene's pool.
Other consolidation strategies can be used by setting the `method` argument, as described below.

```{r}
out$gene$simes[[1]]
```

As with `runVoom()`, the `runVoomScreen()` function will produce a Rmarkdown report describing the exact steps that were performed.
This will be automatically tracked using Git to preserve the history of the analyses.

# Further options

Any option that is supported by `runVoom()` can also be used here.
For example, we might prefer to analyze our data by treating `run` as a random effect via `duplicateCorrelation()`:

```{r, fig.show="hide"}
out.dc <- runVoomScreen(se, covariates="time", comparisons='time',
    dup.cor="run", reference.field="time", reference.level=0,
    norm.type.field="Type", norm.type.level="NEG", gene.field="ID")                        
out.dc$barcode
```

The screen-specific options can also be fine-tuned:

- If `reference.field=NULL`, we default to `r Biocpkg("edgeR")`'s default filtering (see `?filterByExpr`). 
  This simply removes low-abundance barcodes using a CPM-based threshold.
  If `reference.field=NA`, no filtering is performed, which may be useful for debugging purposes.
- If `norm.type.field=NULL`, we default to TMM normalization across all barcodes (see `?calcNormFactors`). 
  This makes the assumption that most barcodes do not change the abundance, which may or may not be reasonable.
  If `norm.type.field=NA`, no normalization is performed beyond library size normalization - this may be the "least worst" option in experiments with large systematic changes in abundance and no negative controls.
- If `gene.field=NA`, no post-contrast gene-level consoliation is performed and only the barcode-level statistics are reported.

Different strategies are available to consolidate barcode-level statistics into per-gene results.
This is controlled via the `method` argument, where one or more strategies can be specified:

- `method="simes"` will reject the null if any barcode has a strong effect.
  This makes it sensitive to off-target effects, which is useful for identifying affected genes.
- `method="holm-mid"` will only reject the null if at least 3 or 40% of barcodes for a gene have a strong effect.
  This improves robustness to off-target effects without requiring a response in every barcode.
- `method="fry"` will apply a `fry()` gene set analysis to the set of barcodes for a given gene.
  This improves detection of genes with a small but consistent effect across all barcodes.

Further customization can take place by directly modifying the Rmarkdown report.
Be sure to track any changes using Git!

# Session information

```{r}
sessionInfo()
```
